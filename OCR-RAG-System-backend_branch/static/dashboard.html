<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG Chat - Testing Mode</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="sidebar-layout.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <div class="sidebar">
    <h1>ðŸ§ª Test Dashboard</h1>
    <p style="color: #666; font-size: 12px; padding: 0 20px;">Testing Mode - No Auth Required</p>
    <a href="dashboard.html" class="active">Dashboard</a>
    <a href="upload_docs.html">Upload</a>
    <a href="sheets.html">Sheet</a>
  </div>
  <div class="content">
    <div class="title">RAG Chat - Ask about your documents</div>
    <div id="chatWindow" class="chat-window"></div>
    <div class="chat-input-container">
      <input type="text" id="chatInput" class="chat-input" placeholder="Ask me anything about your receipts...">
      <button id="sendBtn" class="send-btn">Send</button>
    </div>
  </div>

  <script>
    // Function to add a message to the chat window
    function addMessage(text, type) {
      const chatWindow = document.getElementById("chatWindow");
      const msg = document.createElement("div");
      msg.className = `message ${type}`;

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      // Use marked to parse markdown if it's a bot message, otherwise just text
      if (type === 'bot') {
        bubble.innerHTML = marked.parse(text);
      } else {
        bubble.textContent = text;
      }

      msg.appendChild(bubble);
      chatWindow.appendChild(msg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      return msg;
    }

    // Send message function
    async function sendMessage() {
      const input = document.getElementById("chatInput");
      const text = input.value.trim();

      if (!text) return;

      // Show user's message
      addMessage(text, "user");
      input.value = "";

      // Show loading message
      const loadingMsg = addMessage("Thinking...", "bot");

      // Call RAG API (no authentication needed in testing mode)
      const apiUrl = "http://127.0.0.1:8000/api/chat";
      console.log("ðŸ” Calling API:", apiUrl);

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer test_token"  // Dummy token for testing
          },
          body: JSON.stringify({ query: text })
        });

        console.log("ðŸ“¥ Response status:", response.status);

        const data = await response.json();

        // Remove loading message
        loadingMsg.remove();

        if (!response.ok) {
          // Show error from server
          addMessage(`âŒ Error: ${data.detail || 'Unknown error'}`, "bot");
          console.error("Server error:", data);
        } else {
          // Show bot response
          addMessage(data.response, "bot");
        }

      } catch (error) {
        console.error("Chat error:", error);
        loadingMsg.remove();
        addMessage(`âŒ Error: ${error.message}. Check console for details.`, "bot");
      }
    }

    // Enter key support
    document.getElementById("chatInput").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // Send button click support
    document.getElementById("sendBtn").addEventListener("click", sendMessage);

    // Welcome message
    addMessage("Hello! I'm your RAG assistant. Ask me anything about your uploaded documents!", "bot");

  </script>
</body>

</html>